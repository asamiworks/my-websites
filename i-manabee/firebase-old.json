{
  "projects": {
    "default": "i-manabee",
    "staging": "i-manabee-staging",
    "production": "i-manabee"
  },
  "hosting": [
    {
      "target": "staging",
      "public": "out",
      "ignore": [
        "firebase.json",
        "**/.*",
        "**/node_modules/**"
      ],
      "rewrites": [
        {
          "source": "**",
          "destination": "/index.html"
        }
      ],
      "headers": [
        {
          "source": "**/*.@(jpg|jpeg|gif|png|svg|webp|ico)",
          "headers": [
            {
              "key": "Cache-Control",
              "value": "public, max-age=31536000, immutable"
            }
          ]
        },
        {
          "source": "**/*.@(js|css)",
          "headers": [
            {
              "key": "Cache-Control",
              "value": "public, max-age=31536000, immutable"
            }
          ]
        },
        {
          "source": "/api/**",
          "headers": [
            {
              "key": "Cache-Control",
              "value": "no-cache, no-store, must-revalidate"
            }
          ]
        }
      ],
      "cleanUrls": true,
      "trailingSlash": false
    },
    {
      "target": "production",
      "public": "out",
      "ignore": [
        "firebase.json",
        "**/.*",
        "**/node_modules/**"
      ],
      "rewrites": [
        {
          "source": "**",
          "destination": "/index.html"
        }
      ],
      "headers": [
        {
          "source": "**/*.@(jpg|jpeg|gif|png|svg|webp|ico)",
          "headers": [
            {
              "key": "Cache-Control",
              "value": "public, max-age=31536000, immutable"
            },
            {
              "key": "X-Content-Type-Options",
              "value": "nosniff"
            }
          ]
        },
        {
          "source": "**/*.@(js|css)",
          "headers": [
            {
              "key": "Cache-Control",
              "value": "public, max-age=31536000, immutable"
            },
            {
              "key": "X-Content-Type-Options",
              "value": "nosniff"
            }
          ]
        },
        {
          "source": "/api/**",
          "headers": [
            {
              "key": "Cache-Control",
              "value": "no-cache, no-store, must-revalidate"
            },
            {
              "key": "X-Frame-Options",
              "value": "DENY"
            },
            {
              "key": "X-Content-Type-Options",
              "value": "nosniff"
            },
            {
              "key": "Referrer-Policy",
              "value": "strict-origin-when-cross-origin"
            }
          ]
        },
        {
          "source": "**",
          "headers": [
            {
              "key": "X-Frame-Options",
              "value": "DENY"
            },
            {
              "key": "X-Content-Type-Options",
              "value": "nosniff"
            },
            {
              "key": "Referrer-Policy",
              "value": "strict-origin-when-cross-origin"
            },
            {
              "key": "Strict-Transport-Security",
              "value": "max-age=63072000; includeSubDomains; preload"
            }
          ]
        }
      ],
      "cleanUrls": true,
      "trailingSlash": false
    }
  ],
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "storage": {
    "rules": "storage.rules"
  },
  "emulators": {
    "auth": {
      "port": 9099
    },
    "firestore": {
      "port": 8080
    },
    "storage": {
      "port": 9199
    },
    "hosting": {
      "port": 5000
    },
    "ui": {
      "enabled": true,
      "port": 4000
    },
    "singleProjectMode": true
  }
}
const firebaserc = {
  "projects": {
    "default": "i-manabee-prod",
    "development": "i-manabee-dev",
    "staging": "i-manabee-staging"
  }
};

// ========================================
// public/js/firebase-config.js - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´Firebaseè¨­å®š
// ========================================
const firebaseConfigJS = `
// Firebaseè¨­å®šï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰
// æ³¨æ„: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…¬é–‹ã•ã‚Œã‚‹ãŸã‚ã€APIã‚­ãƒ¼ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚€

const firebaseConfig = {
    apiKey: "YOUR_API_KEY", // TODO: Firebase Consoleã‹ã‚‰å–å¾—
    authDomain: "i-manabee-prod.firebaseapp.com",
    projectId: "i-manabee-prod",
    storageBucket: "i-manabee-prod.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
    measurementId: "YOUR_MEASUREMENT_ID"
};

// FirebaseåˆæœŸåŒ–
let app;
let auth;
let db;

// åˆæœŸåŒ–é–¢æ•°
async function initializeFirebase() {
    try {
        // Firebaseã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
        app = firebase.initializeApp(firebaseConfig);
        
        // èªè¨¼ã®åˆæœŸåŒ–
        auth = firebase.auth();
        
        // Firestoreã®åˆæœŸåŒ–
        db = firebase.firestore();
        
        // é–‹ç™ºç’°å¢ƒã§ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æ¥ç¶š
        if (location.hostname === 'localhost') {
            console.log('ğŸ”§ é–‹ç™ºç’°å¢ƒæ¤œå‡º: ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã«æ¥ç¶šã—ã¾ã™');
            
            // Auth ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿
            auth.useEmulator('http://localhost:9099');
            
            // Firestore ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿
            db.useEmulator('localhost', 8080);
        }
        
        console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
        return { app, auth, db };
        
    } catch (error) {
        console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
    }
}

// èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
function onAuthStateChanged(callback) {
    return auth.onAuthStateChanged(callback);
}

// ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
async function signUp(email, password) {
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log('âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæˆåŠŸ');
        return userCredential.user;
    } catch (error) {
        console.error('âŒ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
        throw handleAuthError(error);
    }
}

// ã‚µã‚¤ãƒ³ã‚¤ãƒ³
async function signIn(email, password) {
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
        return userCredential.user;
    } catch (error) {
        console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        throw handleAuthError(error);
    }
}

// ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
async function signOut() {
    try {
        await auth.signOut();
        console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
    } catch (error) {
        console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        throw error;
    }
}

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
function handleAuthError(error) {
    const errorMessages = {
        'auth/email-already-in-use': 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™',
        'auth/invalid-email': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“',
        'auth/operation-not-allowed': 'ã“ã®æ“ä½œã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“',
        'auth/weak-password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„',
        'auth/user-disabled': 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™',
        'auth/user-not-found': 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
        'auth/wrong-password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™',
        'auth/network-request-failed': 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    };
    
    const message = errorMessages[error.code] || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    return new Error(message);
}

// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
async function createDocument(collection, data) {
    try {
        const docRef = await db.collection(collection).add({
            ...data,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return docRef.id;
    } catch (error) {
        console.error('Firestoreæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
    }
}

// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—
async function getDocument(collection, docId) {
    try {
        const doc = await db.collection(collection).doc(docId).get();
        if (doc.exists) {
            return { id: doc.id, ...doc.data() };
        } else {
            return null;
        }
    } catch (error) {
        console.error('Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
    }
}

// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
async function updateDocument(collection, docId, data) {
    try {
        await db.collection(collection).doc(docId).update({
            ...data,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Firestoreæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
    }
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼
function subscribeToDocument(collection, docId, callback) {
    return db.collection(collection).doc(docId)
        .onSnapshot((doc) => {
            if (doc.exists) {
                callback({ id: doc.id, ...doc.data() });
            } else {
                callback(null);
            }
        });
}

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼‰
window.FirebaseService = {
    initializeFirebase,
    onAuthStateChanged,
    signUp,
    signIn,
    signOut,
    createDocument,
    getDocument,
    updateDocument,
    subscribeToDocument
};
`;

// ========================================
// server/utils/firebase.js - ã‚µãƒ¼ãƒãƒ¼å´Firebase Adminè¨­å®š
// ========================================
const firebaseAdminJS = `
// Firebase Admin SDKè¨­å®šï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰
const admin = require('firebase-admin');

// ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
const serviceAccount = {
    type: "service_account",
    project_id: process.env.FIREBASE_PROJECT_ID || "i-manabee-prod",
    private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
    private_key: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n'),
    client_email: process.env.FIREBASE_CLIENT_EMAIL,
    client_id: process.env.FIREBASE_CLIENT_ID,
    auth_uri: "https://accounts.google.com/o/oauth2/auth",
    token_uri: "https://oauth2.googleapis.com/token",
    auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    client_x509_cert_url: process.env.FIREBASE_CERT_URL
};

// Firebase AdminåˆæœŸåŒ–
let initialized = false;

function initializeAdmin() {
    if (!initialized) {
        try {
            admin.initializeApp({
                credential: admin.credential.cert(serviceAccount),
                databaseURL: \`https://\${serviceAccount.project_id}.firebaseio.com\`
            });
            initialized = true;
            console.log('âœ… Firebase Admin SDKåˆæœŸåŒ–å®Œäº†');
        } catch (error) {
            console.error('âŒ Firebase Admin SDKåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            throw error;
        }
    }
    return admin;
}

// Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—
function getFirestore() {
    initializeAdmin();
    return admin.firestore();
}

// èªè¨¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—
function getAuth() {
    initializeAdmin();
    return admin.auth();
}

// ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
async function verifyToken(idToken) {
    try {
        const auth = getAuth();
        const decodedToken = await auth.verifyIdToken(idToken);
        return decodedToken;
    } catch (error) {
        console.error('ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        throw new Error('èªè¨¼ã‚¨ãƒ©ãƒ¼');
    }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
async function createUser(email, password, displayName) {
    try {
        const auth = getAuth();
        const userRecord = await auth.createUser({
            email,
            password,
            displayName,
            emailVerified: false,
            disabled: false
        });
        return userRecord;
    } catch (error) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        throw error;
    }
}

// Firestoreãƒãƒƒãƒå‡¦ç†
async function batchWrite(operations) {
    const db = getFirestore();
    const batch = db.batch();
    
    operations.forEach(op => {
        if (op.type === 'create') {
            const ref = db.collection(op.collection).doc();
            batch.set(ref, op.data);
        } else if (op.type === 'update') {
            const ref = db.collection(op.collection).doc(op.id);
            batch.update(ref, op.data);
        } else if (op.type === 'delete') {
            const ref = db.collection(op.collection).doc(op.id);
            batch.delete(ref);
        }
    });
    
    await batch.commit();
}

module.exports = {
    initializeAdmin,
    getFirestore,
    getAuth,
    verifyToken,
    createUser,
    batchWrite
};
`;

// ========================================
// firestore.rules - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
// ========================================
const firestoreRules = `
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®ç¢ºèª
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // æœ¬äººç¢ºèª
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ä¿è­·è€…ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false; // å‰Šé™¤ã¯ç®¡ç†è€…ã®ã¿
      
      // å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
      match /children/{childId} {
        allow read, write: if isOwner(userId);
      }
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ£ãƒƒãƒˆ
      match /active_chats/{chatId} {
        allow read, write: if isOwner(userId);
      }
      
      // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆï¼ˆæœ‰æ–™ãƒ—ãƒ©ãƒ³ã®ã¿ï¼‰
      match /archived_chats/{chatId} {
        allow read, write: if isOwner(userId) && 
          get(/databases/$(database)/documents/users/$(userId)/profile).data.plan in ['premium', 'family'];
      }
      
      // åˆ©ç”¨çŠ¶æ³ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
      match /usage_tracking/{document=**} {
        allow read: if isOwner(userId);
        allow write: if false; // ã‚µãƒ¼ãƒãƒ¼å´ã®ã¿æ›¸ãè¾¼ã¿å¯
      }
      
      // å®‰å…¨ãƒ­ã‚°
      match /safety_logs/{logId} {
        allow read: if isOwner(userId);
        allow write: if false; // ã‚µãƒ¼ãƒãƒ¼å´ã®ã¿æ›¸ãè¾¼ã¿å¯
      }
      
      // ãƒ¬ãƒãƒ¼ãƒˆ
      match /reports/{reportType}/{reportId} {
        allow read: if isOwner(userId);
        allow write: if false; // ã‚µãƒ¼ãƒãƒ¼å´ã®ã¿æ›¸ãè¾¼ã¿å¯
      }
    }
    
    // ãã®ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
`;

// ========================================
// .env.local ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
// ========================================
const envTemplate = `
# Firebaseè¨­å®š
FIREBASE_PROJECT_ID=i-manabee-prod
FIREBASE_PRIVATE_KEY_ID=your_private_key_id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\\nyour_private_key\\n-----END PRIVATE KEY-----\\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@i-manabee-prod.iam.gserviceaccount.com
FIREBASE_CLIENT_ID=your_client_id
FIREBASE_CERT_URL=https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-xxxxx%40i-manabee-prod.iam.gserviceaccount.com

# AI API Keysï¼ˆæ—¢å­˜ï¼‰
OPENAI_API_KEY=your_existing_openai_key
ANTHROPIC_API_KEY=your_existing_anthropic_key
GOOGLE_AI_API_KEY=your_gemini_api_key

# Stripeï¼ˆå¾Œã§è¨­å®šï¼‰
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret

# Session Secret
SESSION_SECRET=manabee-secret-key-2025-change-this-in-production

# Environment
NODE_ENV=development
PORT=3000
`;

// JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
module.exports = {
    firebaseJson,
    firebaserc,
    firebaseConfigJS,
    firebaseAdminJS,
    firestoreRules,
    envTemplate
};