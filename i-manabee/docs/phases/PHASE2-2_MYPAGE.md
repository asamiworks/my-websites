# ğŸ‘¤ Phase 2.2: ãƒã‚¤ãƒšãƒ¼ã‚¸å®Ÿè£…ä»•æ§˜

æœ€çµ‚æ›´æ–°: 2025-10-07  
Version: 1.0.0  
å®Ÿè£…æœŸé–“: Week 3ï¼ˆ2025-10-21 ã€œ 2025-10-27ï¼‰

---

## ğŸ“š å‰æãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**å¿…èª­ï¼ˆClaude CODEã¯ã“ã‚Œã‚‰ã‚’å…ˆã«èª­ã‚€ã“ã¨ï¼‰**:
1. [DESIGN_SYSTEM.md](../DESIGN_SYSTEM.md) - UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
2. [TYPE_REFERENCE.md](../TYPE_REFERENCE.md) - Child, Userå‹
3. [DIRECTORY_STRUCTURE.md](../DIRECTORY_STRUCTURE.md) - ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®
4. [PHASE2-1_AUTH.md](./PHASE2-1_AUTH.md) - èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå‰æï¼‰

---

## ğŸ¯ ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã®ç›®çš„

ä¿è­·è€…ãŒå­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ã€å„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§PINèªè¨¼ã—ã¦ãƒãƒ£ãƒƒãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

### é”æˆç›®æ¨™
- [ ] å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ /ç·¨é›†/å‰Šé™¤ã§ãã‚‹
- [ ] ã‚¢ãƒã‚¿ãƒ¼ã‚’8ç¨®é¡ã‹ã‚‰é¸æŠã§ãã‚‹
- [ ] 4æ¡ã®PINã‚’è¨­å®šã§ãã‚‹
- [ ] PINã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å­ã©ã‚‚è¦–ç‚¹ã®ãƒãƒ£ãƒƒãƒˆãŒã§ãã‚‹
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å…¨ä½“ã®ä½¿ç”¨çŠ¶æ³ãŒè¦‹ãˆã‚‹

---

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Day 15-17: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å¼·åŒ–ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†

#### Day 15: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å¼·åŒ–
- [ ] ä½¿ç”¨çŠ¶æ³ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
- [ ] ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤º
- [ ] å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚«ãƒ¼ãƒ‰
- [ ] ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ‹¡å¼µ

#### Day 16: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†
- [ ] `app/(dashboard)/profile/page.tsx` ä½œæˆ
- [ ] ä¿è­·è€…æƒ…å ±ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
- [ ] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
- [ ] è¨­å®šï¼ˆé€šçŸ¥ç­‰ï¼‰

#### Day 17: è¨­å®šç”»é¢
- [ ] `app/(dashboard)/settings/page.tsx` ä½œæˆ
- [ ] ãƒ¡ãƒ¼ãƒ«é€šçŸ¥è¨­å®š
- [ ] é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆè¨­å®š
- [ ] å®‰å…¨æ€§ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

### Day 18-21: å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†

#### Day 18: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
- [ ] `app/(dashboard)/children/page.tsx` ä½œæˆ
- [ ] `components/profile/ChildCard.tsx` ä½œæˆ
- [ ] `components/profile/ChildList.tsx` ä½œæˆ
- [ ] ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º

#### Day 19: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 
- [ ] `app/(dashboard)/children/new/page.tsx` ä½œæˆ
- [ ] `components/profile/ChildForm.tsx` ä½œæˆ
- [ ] `components/profile/AvatarSelector.tsx` ä½œæˆ
- [ ] ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ç”Ÿå¹´æœˆã€ã‚¢ãƒã‚¿ãƒ¼ã€PINè¨­å®š

#### Day 20: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ãƒ»å‰Šé™¤
- [ ] `app/(dashboard)/children/[id]/page.tsx` ä½œæˆ
- [ ] ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
- [ ] å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- [ ] Firestore CRUDæ“ä½œ

#### Day 21: PINèªè¨¼
- [ ] `components/profile/PinDialog.tsx` ä½œæˆ
- [ ] PINã«ã‚ˆã‚‹å­ã©ã‚‚ãƒ­ã‚°ã‚¤ãƒ³
- [ ] ãƒãƒ£ãƒƒãƒˆç”»é¢ã¨ã®é€£æº
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
ä¿è­·è€…ãƒ­ã‚°ã‚¤ãƒ³
â†“
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â†“
å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
â†“
ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ PINå…¥åŠ›
â†“
PINæ¤œè¨¼ï¼ˆFirestoreï¼‰
â†“
å­ã©ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
â†“
ãƒãƒ£ãƒƒãƒˆç”»é¢ï¼ˆå­ã©ã‚‚è¦–ç‚¹ï¼‰

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆæ–°è¦ä½œæˆåˆ†ï¼‰
src/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ (dashboard)/
â”‚       â”œâ”€â”€ dashboard/
â”‚       â”‚   â””â”€â”€ page.tsx              # å¼·åŒ–
â”‚       â”œâ”€â”€ profile/
â”‚       â”‚   â””â”€â”€ page.tsx              âœ¨ æ–°è¦
â”‚       â”œâ”€â”€ children/
â”‚       â”‚   â”œâ”€â”€ page.tsx              âœ¨ æ–°è¦ï¼ˆä¸€è¦§ï¼‰
â”‚       â”‚   â”œâ”€â”€ new/
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx          âœ¨ æ–°è¦ï¼ˆè¿½åŠ ï¼‰
â”‚       â”‚   â””â”€â”€ [id]/
â”‚       â”‚       â””â”€â”€ page.tsx          âœ¨ æ–°è¦ï¼ˆç·¨é›†ï¼‰
â”‚       â””â”€â”€ settings/
â”‚           â””â”€â”€ page.tsx              âœ¨ æ–°è¦
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ StatsCard.tsx             # æ—¢å­˜
â”‚   â”‚   â”œâ”€â”€ RecentActivity.tsx        âœ¨ æ–°è¦
â”‚   â”‚   â””â”€â”€ QuickActions.tsx          âœ¨ æ–°è¦
â”‚   â”‚
â”‚   â””â”€â”€ profile/
â”‚       â”œâ”€â”€ ChildCard.tsx             âœ¨ æ–°è¦
â”‚       â”œâ”€â”€ ChildList.tsx             âœ¨ æ–°è¦
â”‚       â”œâ”€â”€ ChildForm.tsx             âœ¨ æ–°è¦
â”‚       â”œâ”€â”€ AvatarSelector.tsx        âœ¨ æ–°è¦
â”‚       â””â”€â”€ PinDialog.tsx             âœ¨ æ–°è¦
â”‚
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ firebase/
â”‚       â””â”€â”€ children.ts               âœ¨ æ–°è¦
â”‚
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ profileStore.ts               âœ¨ æ–°è¦
â”‚
â””â”€â”€ hooks/
â”œâ”€â”€ useChildren.ts                âœ¨ æ–°è¦
â””â”€â”€ useProfile.ts                 âœ¨ æ–°è¦

---

## ğŸ“± ç”»é¢ä»•æ§˜

### 1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å¼·åŒ– (`/dashboard`)

#### UIè¦ä»¶ï¼ˆæ›´æ–°ç‰ˆï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header                    [ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ã“ã‚“ã«ã¡ã¯ã€ã€‡ã€‡ã•ã‚“ï¼              â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ä½¿ç”¨çŠ¶æ³  â”‚ â”‚ãƒ—ãƒ©ãƒ³    â”‚ â”‚å­ã©ã‚‚ â”‚â”‚
â”‚  â”‚ 20/100  â”‚ â”‚ç„¡æ–™      â”‚ â”‚ 2äºº   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ğŸ» ãŸã‚ã†â”‚ â”‚ğŸ° ã¯ãªã“â”‚ [+è¿½åŠ ]  â”‚
â”‚  â”‚9æ­³      â”‚ â”‚7æ­³      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                     â”‚
â”‚  ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³                  â”‚
â”‚  [ãƒãƒ£ãƒƒãƒˆ] [ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†]       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

#### ã‚³ãƒ¼ãƒ‰ä¾‹

**`app/(dashboard)/dashboard/page.tsx`ï¼ˆæ›´æ–°ç‰ˆï¼‰**
```tsx
'use client';

import { useAuth } from '@/hooks/useAuth';
import { useChildren } from '@/hooks/useChildren';
import { StatsCard } from '@/components/dashboard/StatsCard';
import { ChildCard } from '@/components/profile/ChildCard';
import { Button } from '@/components/ui/Button';
import Link from 'next/link';
import { useState } from 'react';
import { PinDialog } from '@/components/profile/PinDialog';
import { useRouter } from 'next/navigation';

export default function DashboardPage() {
  const router = useRouter();
  const { user } = useAuth();
  const { children, loading } = useChildren();
  const [selectedChild, setSelectedChild] = useState<string | null>(null);
  
  if (!user) return null;
  
  const handleChildSelect = (childId: string) => {
    setSelectedChild(childId);
  };
  
  const handlePinVerified = (childId: string) => {
    // PINãŒæ­£ã—ã‘ã‚Œã°ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸
    router.push(`/chat?childId=${childId}`);
  };
  
  return (
    <div className="max-w-6xl mx-auto space-y-8">
      {/* Welcome Message */}
      <div>
        <h1 className="text-3xl font-bold text-gray-800 mb-2">
          ã“ã‚“ã«ã¡ã¯ã€{user.displayName || 'ã¾ãªã³ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼'}ã•ã‚“ï¼
        </h1>
        <p className="text-gray-600">
          ä»Šæ—¥ã‚‚æ¥½ã—ãå­¦ç¿’ã—ã¾ã—ã‚‡ã† ğŸ
        </p>
      </div>
      
      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <StatsCard
          title="ä½¿ç”¨çŠ¶æ³"
          value="0 / âˆ"
          description="ä»ŠæœŸã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡"
          icon="ğŸ“Š"
        />
        <StatsCard
          title="ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³"
          value={getPlanName(user.plan)}
          description="ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§æ›´ã«ä¾¿åˆ©ã«"
          icon="â­"
        />
        <StatsCard
          title="å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«"
          value={`${children.length}äºº`}
          description={`æœ€å¤§${getMaxChildren(user.plan)}äººã¾ã§`}
          icon="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"
        />
      </div>
      
      {/* Children Profiles */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold text-gray-800">
            å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
          </h2>
          {children.length < getMaxChildren(user.plan) && (
            <Link href="/children/new">
              <Button variant="outline">
                â• ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
              </Button>
            </Link>
          )}
        </div>
        
        {loading ? (
          <p className="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
        ) : children.length === 0 ? (
          <div className="bg-white rounded-lg shadow-md p-8 text-center">
            <p className="text-gray-600 mb-4">
              ã¾ã å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“
            </p>
            <Link href="/children/new">
              <Button>
                æœ€åˆã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
              </Button>
            </Link>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {children.map((child) => (
              <ChildCard
                key={child.id}
                child={child}
                onSelect={() => handleChildSelect(child.id)}
              />
            ))}
          </div>
        )}
      </div>
      
      {/* Quick Actions */}
      <div>
        <h2 className="text-xl font-bold text-gray-800 mb-4">
          ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <Link href="/children">
            <Button variant="outline" className="w-full h-20 text-lg">
              ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
            </Button>
          </Link>
          <Link href="/profile">
            <Button variant="outline" className="w-full h-20 text-lg">
              âš™ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
            </Button>
          </Link>
        </div>
      </div>
      
      {/* PIN Dialog */}
      {selectedChild && (
        <PinDialog
          childId={selectedChild}
          onVerified={handlePinVerified}
          onClose={() => setSelectedChild(null)}
        />
      )}
    </div>
  );
}

function getPlanName(plan: string): string {
  switch (plan) {
    case 'free': return 'ç„¡æ–™ãƒ—ãƒ©ãƒ³';
    case 'kids': return 'ã¾ãªã³ãƒ¼ã‚­ãƒƒã‚º';
    case 'friends': return 'ã¾ãªã³ãƒ¼ãƒ•ãƒ¬ãƒ³ã‚º';
    case 'premium': return 'ã¾ãªã³ãƒ¼ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ';
    default: return 'ç„¡æ–™ãƒ—ãƒ©ãƒ³';
  }
}

function getMaxChildren(plan: string): number {
  switch (plan) {
    case 'free': return 1;
    case 'kids': return 1;
    case 'friends': return 3;
    case 'premium': return 5;
    default: return 1;
  }
}

2. å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ (/children)
UIè¦ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ» ãŸã‚ã†        [ç·¨é›†] [å‰Šé™¤]â”‚   â”‚
â”‚  â”‚ 9æ­³ãƒ»å°å­¦3å¹´ç”Ÿ               â”‚   â”‚
â”‚  â”‚ æœ€çµ‚åˆ©ç”¨: 2æ™‚é–“å‰            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ° ã¯ãªã“        [ç·¨é›†] [å‰Šé™¤]â”‚   â”‚
â”‚  â”‚ 7æ­³ãƒ»å°å­¦1å¹´ç”Ÿ               â”‚   â”‚
â”‚  â”‚ æœ€çµ‚åˆ©ç”¨: æ˜¨æ—¥               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  [â• æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ]     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã‚³ãƒ¼ãƒ‰ä¾‹
app/(dashboard)/children/page.tsx
tsx'use client';

import { useAuth } from '@/hooks/useAuth';
import { useChildren } from '@/hooks/useChildren';
import { ChildCard } from '@/components/profile/ChildCard';
import { Button } from '@/components/ui/Button';
import Link from 'next/link';

export default function ChildrenPage() {
  const { user } = useAuth();
  const { children, loading, deleteChild } = useChildren();
  
  if (!user) return null;
  
  const maxChildren = getMaxChildren(user.plan);
  const canAddMore = children.length < maxChildren;
  
  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">
            å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
          </h1>
          <p className="text-gray-600 mt-1">
            {children.length} / {maxChildren}äºº
          </p>
        </div>
        
        {canAddMore && (
          <Link href="/children/new">
            <Button>
              â• æ–°è¦ä½œæˆ
            </Button>
          </Link>
        )}
      </div>
      
      {loading ? (
        <div className="text-center py-12">
          <p className="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      ) : children.length === 0 ? (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <div className="text-6xl mb-4">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
          <h2 className="text-xl font-bold text-gray-800 mb-2">
            ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“
          </h2>
          <p className="text-gray-600 mb-6">
            ãŠå­æ§˜ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€<br />
            AIã¨ã®å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†
          </p>
          <Link href="/children/new">
            <Button>
              æœ€åˆã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            </Button>
          </Link>
        </div>
      ) : (
        <div className="space-y-4">
          {children.map((child) => (
            <div key={child.id} className="bg-white rounded-lg shadow-md p-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="text-5xl">{getAvatarEmoji(child.avatar)}</div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-800">
                      {child.nickname}
                    </h3>
                    <p className="text-gray-600">
                      {getAgeDisplay(child.birthMonth)} Â· {getAgeGroupLabel(child.ageGroup)}
                    </p>
                    <p className="text-sm text-gray-500">
                      æœ€çµ‚åˆ©ç”¨: {getLastActiveDisplay(child.lastActive)}
                    </p>
                  </div>
                </div>
                
                <div className="flex gap-2">
                  <Link href={`/children/${child.id}`}>
                    <Button variant="outline" size="sm">
                      ç·¨é›†
                    </Button>
                  </Link>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => handleDelete(child.id)}
                  >
                    å‰Šé™¤
                  </Button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
      
      {!canAddMore && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p className="text-sm text-yellow-800">
            ğŸ’¡ ãƒ—ãƒ©ãƒ³ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚<br />
            ã‚ˆã‚Šå¤šãã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€
            <Link href="/pricing" className="underline font-medium">
              ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
            </Link>
            ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      )}
    </div>
  );
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¯çœç•¥ï¼ˆå®Ÿè£…æ™‚ã«è¿½åŠ ï¼‰

3. å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ (/children/new)
UIè¦ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ                         â”‚
â”‚  [ãŸã‚ã†                          ] â”‚
â”‚                                     â”‚
â”‚  ç”Ÿã¾ã‚ŒãŸæœˆ                          â”‚
â”‚  [2016å¹´4æœˆ â–¼]                     â”‚
â”‚                                     â”‚
â”‚  ã‚¢ãƒã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­                  â”‚
â”‚  [ğŸ»] [ğŸ°] [ğŸ±] [ğŸ¶]              â”‚
â”‚  [ğŸ¼] [ğŸ¦] [ğŸ§] [ğŸ¦Š]              â”‚
â”‚                                     â”‚
â”‚  PINï¼ˆ4æ¡ã®æ•°å­—ï¼‰                   â”‚
â”‚  [1] [2] [3] [4]                   â”‚
â”‚                                     â”‚
â”‚  PINã®ç¢ºèª                          â”‚
â”‚  [1] [2] [3] [4]                   â”‚
â”‚                                     â”‚
â”‚  [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]        [ä½œæˆã™ã‚‹]     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã‚³ãƒ¼ãƒ‰ä¾‹
components/profile/ChildForm.tsx
tsx'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Alert } from '@/components/ui/Alert';
import { AvatarSelector } from '@/components/profile/AvatarSelector';
import { useChildren } from '@/hooks/useChildren';
import type { AvatarType } from '@/types';

const childSchema = z.object({
  nickname: z.string()
    .min(1, 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
    .max(20, 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯20æ–‡å­—ä»¥å†…ã§ã™'),
  birthMonth: z.string().regex(/^\d{4}-\d{2}$/, 'ç”Ÿã¾ã‚ŒãŸæœˆã‚’é¸æŠã—ã¦ãã ã•ã„'),
  avatar: z.string(),
  pin: z.string().regex(/^\d{4}$/, 'PINã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'),
  pinConfirm: z.string(),
}).refine((data) => data.pin === data.pinConfirm, {
  message: 'PINãŒä¸€è‡´ã—ã¾ã›ã‚“',
  path: ['pinConfirm'],
});

type ChildFormData = z.infer<typeof childSchema>;

interface ChildFormProps {
  initialData?: Partial<ChildFormData>;
  onSubmit: (data: ChildFormData) => Promise<void>;
  onCancel: () => void;
  submitLabel?: string;
}

export function ChildForm({ 
  initialData, 
  onSubmit, 
  onCancel,
  submitLabel = 'ä½œæˆã™ã‚‹'
}: ChildFormProps) {
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [selectedAvatar, setSelectedAvatar] = useState<AvatarType>(
    (initialData?.avatar as AvatarType) || 'bear'
  );
  
  const {
    register,
    handleSubmit,
    formState: { errors },
    setValue,
  } = useForm<ChildFormData>({
    resolver: zodResolver(childSchema),
    defaultValues: initialData,
  });
  
  const handleFormSubmit = async (data: ChildFormData) => {
    try {
      setError(null);
      setIsLoading(true);
      await onSubmit(data);
    } catch (err: any) {
      setError(err.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };
  
  const handleAvatarChange = (avatar: AvatarType) => {
    setSelectedAvatar(avatar);
    setValue('avatar', avatar);
  };
  
  return (
    <form onSubmit={handleSubmit(handleFormSubmit)} className="space-y-6">
      {error && (
        <Alert variant="error">
          {error}
        </Alert>
      )}
      
      {/* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  */}
      <Input
        {...register('nickname')}
        label="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ "
        placeholder="ãŸã‚ã†"
        error={errors.nickname?.message}
        disabled={isLoading}
      />
      
      {/* ç”Ÿã¾ã‚ŒãŸæœˆ */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          ç”Ÿã¾ã‚ŒãŸæœˆ
        </label>
        <input
          {...register('birthMonth')}
          type="month"
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-honey-yellow"
          disabled={isLoading}
        />
        {errors.birthMonth && (
          <p className="mt-1 text-sm text-error-red">
            {errors.birthMonth.message}
          </p>
        )}
      </div>
      
      {/* ã‚¢ãƒã‚¿ãƒ¼é¸æŠ */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          ã‚¢ãƒã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­
        </label>
        <AvatarSelector
          selected={selectedAvatar}
          onChange={handleAvatarChange}
        />
        <input
          type="hidden"
          {...register('avatar')}
          value={selectedAvatar}
        />
      </div>
      
      {/* PIN */}
      <Input
        {...register('pin')}
        type="password"
        inputMode="numeric"
        maxLength={4}
        label="PINï¼ˆ4æ¡ã®æ•°å­—ï¼‰"
        placeholder="1234"
        error={errors.pin?.message}
        disabled={isLoading}
        hint="ãƒãƒ£ãƒƒãƒˆé–‹å§‹æ™‚ã«ä½¿ç”¨ã—ã¾ã™"
      />
      
      {/* PINç¢ºèª */}
      <Input
        {...register('pinConfirm')}
        type="password"
        inputMode="numeric"
        maxLength={4}
        label="PINã®ç¢ºèª"
        placeholder="1234"
        error={errors.pinConfirm?.message}
        disabled={isLoading}
      />
      
      {/* ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <Button
          type="button"
          variant="outline"
          onClick={onCancel}
          disabled={isLoading}
          className="flex-1"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
        <Button
          type="submit"
          disabled={isLoading}
          className="flex-1"
        >
          {isLoading ? 'å‡¦ç†ä¸­...' : submitLabel}
        </Button>
      </div>
    </form>
  );
}
components/profile/AvatarSelector.tsx
tsximport type { AvatarType } from '@/types';

const AVATARS: { type: AvatarType; emoji: string; label: string }[] = [
  { type: 'bear', emoji: 'ğŸ»', label: 'ãã¾' },
  { type: 'rabbit', emoji: 'ğŸ°', label: 'ã†ã•ã' },
  { type: 'cat', emoji: 'ğŸ±', label: 'ã­ã“' },
  { type: 'dog', emoji: 'ğŸ¶', label: 'ã„ã¬' },
  { type: 'panda', emoji: 'ğŸ¼', label: 'ãƒ‘ãƒ³ãƒ€' },
  { type: 'lion', emoji: 'ğŸ¦', label: 'ãƒ©ã‚¤ã‚ªãƒ³' },
  { type: 'penguin', emoji: 'ğŸ§', label: 'ãƒšãƒ³ã‚®ãƒ³' },
  { type: 'fox', emoji: 'ğŸ¦Š', label: 'ãã¤ã­' },
];

interface AvatarSelectorProps {
  selected: AvatarType;
  onChange: (avatar: AvatarType) => void;
}

export function AvatarSelector({ selected, onChange }: AvatarSelectorProps) {
  return (
    <div className="grid grid-cols-4 gap-3">
      {AVATARS.map((avatar) => (
        <button
          key={avatar.type}
          type="button"
          onClick={() => onChange(avatar.type)}
          className={`
            p-4 rounded-lg border-2 transition-all
            hover:scale-105 active:scale-95
            ${selected === avatar.type
              ? 'border-honey-yellow bg-honey-yellow bg-opacity-10'
              : 'border-gray-200 hover:border-gray-300'
            }
          `}
        >
          <div className="text-4xl mb-1">{avatar.emoji}</div>
          <div className="text-xs text-gray-600">{avatar.label}</div>
        </button>
      ))}
    </div>
  );
}

4. PINèªè¨¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
components/profile/PinDialog.tsx
tsx'use client';

import { useState } from 'react';
import { Modal } from '@/components/ui/Modal';
import { Button } from '@/components/ui/Button';
import { Alert } from '@/components/ui/Alert';
import { useChildren } from '@/hooks/useChildren';

interface PinDialogProps {
  childId: string;
  onVerified: (childId: string) => void;
  onClose: () => void;
}

export function PinDialog({ childId, onVerified, onClose }: PinDialogProps) {
  const { children, verifyPin } = useChildren();
  const [pin, setPin] = useState(['', '', '', '']);
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  
  const child = children.find(c => c.id === childId);
  
  if (!child) return null;
  
  const handlePinChange = (index: number, value: string) => {
    if (!/^\d*$/.test(value)) return;
    
    const newPin = [...pin];
    newPin[index] = value.slice(-1);
    setPin(newPin);
    
    // æ¬¡ã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    if (value && index < 3) {
      const nextInput = document.getElementById(`pin-${index + 1}`);
      nextInput?.focus();
    }
  };
  
  const handleVerify = async () => {
    const pinValue = pin.join('');
    
    if (pinValue.length !== 4) {
      setError('PINã‚’4æ¡å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    try {
      setError(null);
      setIsLoading(true);
      
      const isValid = await verifyPin(childId, pinValue);
      
      if (isValid) {
        onVerified(childId);
      } else {
        setError('PINãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        setPin(['', '', '', '']);
        // æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        document.getElementById('pin-0')?.focus();
      }
    } catch (err: any) {
      setError(err.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };
  
  return (
    <Modal onClose={onClose}>
      <div className="p-6 space-y-6">
        <div className="text-center">
          <div className="text-6xl mb-4">{getAvatarEmoji(child.avatar)}</div>
          <h2 className="text-2xl font-bold text-gray-800 mb-2">
            {child.nickname}ã®PINã‚’å…¥åŠ›
          </h2>
          <p className="text-gray-600">
            4æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </p>
        </div>
        
        {error && (
          <Alert variant="error">
            {error}
          </Alert>
        )}
        
        {/* PINå…¥åŠ› */}
        <div className="flex justify-center gap-3">
          {pin.map((digit, index) => (
            <input
              key={index}
              id={`pin-${index}`}
              type="password"
              inputMode="numeric"
              maxLength={1}
              value={digit}
              onChange={(e) => handlePinChange(index, e.target.value)}
              className="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-honey-yellow focus:border-transparent"
              disabled={isLoading}
            />
          ))}
        </div>
        
        {/* ãƒœã‚¿ãƒ³ */}
        <div className="flex gap-4">
          <Button
            variant="outline"
            onClick={onClose}
            disabled={isLoading}
            className="flex-1"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </Button>
          <Button
            onClick={handleVerify}
            disabled={isLoading}
            className="flex-1"
          >
            {isLoading ? 'ç¢ºèªä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
          </Button>
        </div>
      </div>
    </Modal>
  );
}

function getAvatarEmoji(avatar: string): string {
  const emojiMap: Record<string, string> = {
    bear: 'ğŸ»',
    rabbit: 'ğŸ°',
    cat: 'ğŸ±',
    dog: 'ğŸ¶',
    panda: 'ğŸ¼',
    lion: 'ğŸ¦',
    penguin: 'ğŸ§',
    fox: 'ğŸ¦Š',
  };
  return emojiMap[avatar] || 'ğŸ»';
}

ğŸ”§ Firebase CRUDæ“ä½œ
lib/firebase/children.ts
typescriptimport {
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  updateDoc,
  deleteDoc,
  query,
  where,
  serverTimestamp,
} from 'firebase/firestore';
import { db } from './config';
import bcrypt from 'bcryptjs';
import type { Child, AvatarType } from '@/types';

/**
 * å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
 */
export async function createChild(
  parentId: string,
  data: {
    nickname: string;
    birthMonth: string;
    avatar: AvatarType;
    pin: string;
  }
): Promise<Child> {
  // PINã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
  const hashedPin = await bcrypt.hash(data.pin, 10);
  
  // å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¨ˆç®—
  const ageGroup = calculateAgeGroup(data.birthMonth);
  
  const childData: Omit<Child, 'id'> = {
    parentId,
    nickname: data.nickname,
    birthMonth: data.birthMonth,
    avatar: data.avatar,
    pin: hashedPin,
    ageGroup,
    createdAt: serverTimestamp() as any,
    lastActive: serverTimestamp() as any,
    isActive: true,
  };
  
  const docRef = doc(collection(db, 'children'));
  await setDoc(docRef, childData);
  
  return {
    id: docRef.id,
    ...childData,
  } as Child;
}

/**
 * å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
 */
export async function getChildren(parentId: string): Promise<Child[]> {
  const q = query(
    collection(db, 'children'),
    where('parentId', '==', parentId),
    where('isActive', '==', true)
  );
  
  const snapshot = await getDocs(q);
  
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
  })) as Child[];
}

/**
 * å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
 */
export async function getChild(childId: string): Promise<Child | null> {
  const docRef = doc(db, 'children', childId);
  const docSnap = await getDoc(docRef);
  
  if (!docSnap.exists()) {
    return null;
  }
  
  return {
    id: docSnap.id,
    ...docSnap.data(),
  } as Child;
}

/**
 * å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°
 */
export async function updateChild(
  childId: string,
  data: Partial<{
    nickname: string;
    birthMonth: string;
    avatar: AvatarType;
    pin: string;
  }>
): Promise<void> {
  const updateData: any = { ...data };
  
  // PINãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒãƒƒã‚·ãƒ¥åŒ–
  if (data.pin) {
    updateData.pin = await bcrypt.hash(data.pin, 10);
  }
  
  // ç”Ÿå¹´æœˆãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å†è¨ˆç®—
  if (data.birthMonth) {
    updateData.ageGroup = calculateAgeGroup(data.birthMonth);
  }
  
  const docRef = doc(db, 'children', childId);
  await updateDoc(docRef, updateData);
}

/**
 * å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
 */
export async function deleteChild(childId: string): Promise<void> {
  const docRef = doc(db, 'children', childId);
  await updateDoc(docRef, {
    isActive: false,
  });
}

/**
 * PINæ¤œè¨¼
 */
export async function verifyChildPin(
  childId: string,
  pin: string
): Promise<boolean> {
  const child = await getChild(childId);
  
  if (!child) {
    return false;
  }
  
  return await bcrypt.compare(pin, child.pin);
}

/**
 * æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚åˆ»æ›´æ–°
 */
export async function updateLastActive(childId: string): Promise<void> {
  const docRef = doc(db, 'children', childId);
  await updateDoc(docRef, {
    lastActive: serverTimestamp(),
  });
}

/**
 * å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ—è¨ˆç®—
 */
function calculateAgeGroup(birthMonth: string): 'junior' | 'middle' | 'senior' {
  const [year, month] = birthMonth.split('-').map(Number);
  const birthDate = new Date(year, month - 1);
  const now = new Date();
  
  const age = now.getFullYear() - birthDate.getFullYear();
  
  if (age <= 9) return 'junior';      // å°å­¦3å¹´ç”Ÿã¾ã§
  if (age <= 15) return 'middle';     // å°å­¦4å¹´ã€œä¸­å­¦ç”Ÿ
  return 'senior';                    // é«˜æ ¡ç”Ÿ
}

ğŸ—„ï¸ çŠ¶æ…‹ç®¡ç†
stores/profileStore.ts
typescriptimport { create } from 'zustand';
import {
  createChild,
  getChildren,
  getChild,
  updateChild,
  deleteChild,
  verifyChildPin,
  updateLastActive,
} from '@/lib/firebase/children';
import type { Child, AvatarType } from '@/types';

interface ChildFormData {
  nickname: string;
  birthMonth: string;
  avatar: AvatarType;
  pin: string;
}

interface ProfileState {
  children: Child[];
  currentChild: Child | null;
  loading: boolean;
  error: string | null;
  
  // Actions
  fetchChildren: (parentId: string) => Promise<void>;
  addChild: (parentId: string, data: ChildFormData) => Promise<void>;
  editChild: (childId: string, data: Partial<ChildFormData>) => Promise<void>;
  removeChild: (childId: string) => Promise<void>;
  verifyPin: (childId: string, pin: string) => Promise<boolean>;
  setCurrentChild: (childId: string) => Promise<void>;
  clearCurrentChild: () => void;
}

export const useProfileStore = create<ProfileState>((set, get) => ({
  children: [],
  currentChild: null,
  loading: false,
  error: null,
  
  fetchChildren: async (parentId) => {
    try {
      set({ loading: true, error: null });
      const children = await getChildren(parentId);
      set({ children, loading: false });
    } catch (error: any) {
      set({ error: error.message, loading: false });
    }
  },
  
  addChild: async (parentId, data) => {
    try {
      set({ loading: true, error: null });
      const child = await createChild(parentId, data);
      set((state) => ({
        children: [...state.children, child],
        loading: false,
      }));
    } catch (error: any) {
      set({ error: error.message, loading: false });
      throw error;
    }
  },
  
  editChild: async (childId, data) => {
    try {
      set({ loading: true, error: null });
      await updateChild(childId, data);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
      const updatedChild = await getChild(childId);
      if (updatedChild) {
        set((state) => ({
          children: state.children.map((c) =>
            c.id === childId ? updatedChild : c
          ),
          loading: false,
        }));
      }
    } catch (error: any) {
      set({ error: error.message, loading: false });
      throw error;
    }
  },
  
  removeChild: async (childId) => {
    try {
      set({ loading: true, error: null });
      await deleteChild(childId);
      set((state) => ({
        children: state.children.filter((c) => c.id !== childId),
        loading: false,
      }));
    } catch (error: any) {
      set({ error: error.message, loading: false });
      throw error;
    }
  },
  
  verifyPin: async (childId, pin) => {
    try {
      const isValid = await verifyChildPin(childId, pin);
      return isValid;
    } catch (error: any) {
      set({ error: error.message });
      return false;
    }
  },
  
  setCurrentChild: async (childId) => {
    const child = await getChild(childId);
    if (child) {
      await updateLastActive(childId);
      set({ currentChild: child });
    }
  },
  
  clearCurrentChild: () => {
    set({ currentChild: null });
  },
}));
hooks/useChildren.ts
typescript'use client';

import { useEffect } from 'react';
import { useAuth } from './useAuth';
import { useProfileStore } from '@/stores/profileStore';

export function useChildren() {
  const { user } = useAuth();
  const store = useProfileStore();
  
  useEffect(() => {
    if (user) {
      store.fetchChildren(user.id);
    }
  }, [user]);
  
  return store;
}

ğŸ§ª ãƒ†ã‚¹ãƒˆ
æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

 ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã§ãã‚‹
 ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒå¿…é ˆ
 ç”Ÿã¾ã‚ŒãŸæœˆã‚’é¸æŠã§ãã‚‹
 8ç¨®é¡ã®ã‚¢ãƒã‚¿ãƒ¼ã‹ã‚‰é¸æŠã§ãã‚‹
 PINã¯4æ¡ã®æ•°å­—ã®ã¿
 PINç¢ºèªãŒä¸€è‡´ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼
 Firestoreã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã‚‹
 PINãŒãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã‚‹

å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†

 ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ç·¨é›†ã§ãã‚‹
 PINã‚’å¤‰æ›´ã§ãã‚‹
 ç·¨é›†å†…å®¹ãŒä¿å­˜ã•ã‚Œã‚‹

å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

 å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
 å‰Šé™¤å¾Œã€ä¸€è¦§ã‹ã‚‰æ¶ˆãˆã‚‹
 è«–ç†å‰Šé™¤ã•ã‚Œã‚‹ï¼ˆisActive = falseï¼‰

PINèªè¨¼

 PINãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
 æ­£ã—ã„PINã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹
 é–“é•ã£ãŸPINã§ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
 ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»

ãƒ—ãƒ©ãƒ³åˆ¶é™

 ç„¡æ–™ãƒ—ãƒ©ãƒ³ã¯1äººã¾ã§
 ã¾ãªã³ãƒ¼ã‚­ãƒƒã‚ºã¯1äººã¾ã§
 ã¾ãªã³ãƒ¼ãƒ•ãƒ¬ãƒ³ã‚ºã¯3äººã¾ã§
 ã¾ãªã³ãƒ¼ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã¯5äººã¾ã§
 ä¸Šé™ã«é”ã™ã‚‹ã¨è¿½åŠ ãƒœã‚¿ãƒ³ãŒéè¡¨ç¤º


ğŸ“ Claude CODEã¸ã®æŒ‡ç¤º
å®Ÿè£…æ‰‹é †
Day 15: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å¼·åŒ–

StatsCardè¿½åŠ ï¼ˆå­ã©ã‚‚æ•°è¡¨ç¤ºï¼‰
ChildCard ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º

Day 16-17: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»è¨­å®šç”»é¢

/profile ãƒšãƒ¼ã‚¸ä½œæˆ
/settings ãƒšãƒ¼ã‚¸ä½œæˆ

Day 18: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

/children ãƒšãƒ¼ã‚¸ä½œæˆ
ChildList ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

Day 19: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 

/children/new ãƒšãƒ¼ã‚¸ä½œæˆ
ChildForm ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
AvatarSelector ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
Firebase CRUDå®Ÿè£…

Day 20: ç·¨é›†ãƒ»å‰Šé™¤

/children/[id] ãƒšãƒ¼ã‚¸ä½œæˆ
å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

Day 21: PINèªè¨¼

PinDialog ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
PINæ¤œè¨¼å®Ÿè£…
ãƒãƒ£ãƒƒãƒˆç”»é¢ã¨ã®é€£æº


ğŸ¯ å®Œäº†åŸºæº–

 å­ã©ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®CRUDãŒå‹•ä½œ
 PINèªè¨¼ãŒæ©Ÿèƒ½
 ãƒ—ãƒ©ãƒ³åˆ¥ã®äººæ•°åˆ¶é™ãŒæ©Ÿèƒ½
 ã™ã¹ã¦ã®æ‰‹å‹•ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ
 PROGRESS.mdæ›´æ–°


æœ€çµ‚æ›´æ–°: 2025-10-07
æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚º: PHASE2-3_PAYMENT.md