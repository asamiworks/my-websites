# ローカル請求書システム 要件仕様書

## プロジェクト概要

### 目的
クラウドサービス（Firebase、Google Drive）に依存せず、完全にローカル環境で動作する請求書自動生成システムを構築する。ドメイン取得やデプロイ作業なしに、毎月1日の自動請求書生成とローカルファイル保存を実現する。

### 背景
- 既存のクラウド依存システムの運用コスト削減
- データの完全な自社管理による安全性確保
- インターネット接続に依存しない安定運用
- シンプルで保守しやすいシステム構築

## 必須機能

### 🏢 クライアント管理機能
- [ ] クライアント情報の新規登録
  - クライアント名
  - サイト名
  - 住所情報（郵便番号、住所1、住所2）
  - 請求サイクル（月次/年次）
  - 管理費
  - 契約期間（開始日、終了日）
  - 料金変更情報（変更日、新管理費）

- [ ] クライアント情報の編集・更新
- [ ] クライアント情報の削除（論理削除）
- [ ] クライアント一覧表示とソート機能
- [ ] クライアント検索・フィルタリング機能

### 📄 請求書生成機能
- [ ] 月次請求書の自動生成
  - 対象月の自動判定
  - 料金変更日の自動適用
  - 契約期間による生成制御
  - 請求サイクル（月次/年次）の考慮

- [ ] 請求書データの管理
  - 一意な請求書番号の生成
  - 請求書詳細情報の保存
  - 請求書ステータス管理（発行済み/支払済み/期限切れ）

- [ ] プレビュー機能
  - 生成前の請求書一覧確認
  - 合計金額の事前計算表示

### 🎨 PDF生成機能
- [ ] 日本語対応PDF請求書生成
  - 日本式請求書レイアウト
  - 日本語フォント対応
  - 税免税事業者対応（消費税0%）

- [ ] カスタマイズ可能なテンプレート
  - 会社情報の動的表示
  - ロゴ・印鑑等の画像対応
  - レイアウトの調整可能性

### 💾 ローカルストレージ機能
- [ ] JSONファイルベースのデータ管理
  - `data/clients.json`：クライアントデータ
  - `data/invoices.json`：請求書データ
  - `data/company-info.json`：会社情報

- [ ] 月別ディレクトリによるPDF管理
  - `output/YYYY-MM/`：月別請求書保存
  - ファイル名の統一規則

### ⏰ 自動化機能
- [ ] 毎月1日の自動実行
  - cronジョブによるスケジューリング
  - バックグラウンド実行

- [ ] 実行ログ管理
  - 生成結果の記録
  - エラーログの保存
  - 実行履歴の追跡

### 📊 管理ダッシュボード機能
- [ ] システム統計情報表示
  - 総クライアント数
  - 月間請求書生成数
  - 総管理費収入

- [ ] 実行ログ表示
  - 最新の実行結果
  - エラー詳細情報
  - 実行履歴の確認

### ⚙️ システム設定機能
- [ ] 会社情報設定
  - 基本情報（会社名、住所、連絡先）
  - 銀行口座情報
  - 支払い期限設定

- [ ] システム設定
  - 自動実行設定のON/OFF
  - ログレベル設定
  - バックアップ設定

## 非機能要件

### パフォーマンス要件
- [ ] 100件のクライアントで5分以内の一括生成
- [ ] ウェブUI応答時間2秒以内
- [ ] PDF生成時間：1件あたり3秒以内

### 可用性要件
- [ ] ローカル環境での99%稼働率
- [ ] システム再起動後の自動復旧
- [ ] データ破損時の自動バックアップ復旧

### セキュリティ要件
- [ ] ローカルファイルアクセス制限
- [ ] 機密情報の適切な保護
- [ ] 実行ログのアクセス制限

### 保守性要件
- [ ] 設定ファイルによる動作調整
- [ ] エラー時の詳細ログ出力
- [ ] バックアップ・リストア機能

### 互換性要件
- [ ] Ubuntu 24.04 LTS 対応
- [ ] Node.js 20.x 対応
- [ ] 最新ブラウザ対応（Chrome、Firefox、Safari）

## データ要件

### クライアントデータ
```json
{
  "id": "string",
  "clientName": "string",
  "siteName": "string",
  "postalCode": "string",
  "address1": "string",
  "address2": "string?",
  "billingFrequency": "monthly|yearly",
  "managementFee": "number",
  "managementStartDate": "ISO8601",
  "contractStartDate": "ISO8601",
  "contractEndDate": "ISO8601?",
  "feeChangeDate": "ISO8601?",
  "newManagementFee": "number?",
  "isActive": "boolean",
  "createdAt": "ISO8601",
  "updatedAt": "ISO8601"
}
```

### 請求書データ
```json
{
  "id": "string",
  "invoiceNumber": "string",
  "clientId": "string",
  "clientName": "string",
  "billingYear": "number",
  "billingMonth": "number",
  "issueDate": "ISO8601",
  "managementFee": "number",
  "feeStartDate": "ISO8601",
  "feeEndDate": "ISO8601",
  "adjustmentAmount": "number",
  "subtotal": "number",
  "taxAmount": "number",
  "totalAmount": "number",
  "pdfPath": "string",
  "status": "issued|paid|overdue",
  "createdAt": "ISO8601",
  "updatedAt": "ISO8601"
}
```

### 会社情報データ
```json
{
  "name": "string",
  "address": "string",
  "phone": "string",
  "email": "string",
  "taxNumber": "string?",
  "bankInfo": {
    "bankName": "string",
    "branchName": "string",
    "accountType": "string",
    "accountNumber": "string",
    "accountHolder": "string"
  },
  "paymentTerms": "number",
  "logoPath": "string?"
}
```

## インターフェース要件

### ユーザーインターフェース
- [ ] レスポンシブWebデザイン
- [ ] 日本語UI
- [ ] 直感的な操作性
- [ ] アクセシビリティ対応（WCAG 2.1 AA準拠）

### API仕様
- [ ] RESTful API設計
- [ ] JSONデータ形式
- [ ] エラーハンドリング標準化

## 運用要件

### バックアップ要件
- [ ] 日次自動バックアップ
- [ ] 7世代バックアップ保持
- [ ] 外部ストレージへの同期（オプション）

### ログ要件
- [ ] アプリケーションログ
- [ ] 実行履歴ログ
- [ ] エラーログ
- [ ] アクセスログ

### 監視要件
- [ ] システム稼働状況監視
- [ ] ディスク使用量監視
- [ ] プロセス監視

## 制約事項

### 技術制約
- Node.js環境での動作
- ローカルファイルシステムのみ使用
- インターネット接続不要で動作
- 外部サービス依存排除

### 運用制約
- 単一ユーザー環境での使用
- 手動でのバックアップ・リストア
- システム管理者による保守

### リソース制約
- ローカルストレージ容量：最大10GB
- 同時処理クライアント数：最大1000件
- PDF保存期間：2年間

## 成功基準

### 機能的成功基準
- [ ] 全必須機能の正常動作
- [ ] 毎月1日の自動実行成功率 99%以上
- [ ] PDF生成成功率 99.9%以上

### 運用的成功基準
- [ ] 月次運用工数 2時間以下
- [ ] システム障害復旧時間 30分以内
- [ ] データ破損・消失事故 0件

### ユーザビリティ成功基準
- [ ] 新規クライアント登録時間 3分以内
- [ ] 請求書確認・修正時間 5分以内
- [ ] システム習得期間 1日以内

## リスクと対策

### 技術リスク
- **ファイル破損リスク**
  - 対策：定期自動バックアップ、ファイル整合性チェック

- **Node.js版本互換性リスク**
  - 対策：Docker化、版本固定

### 運用リスク
- **手動運用によるヒューマンエラー**
  - 対策：自動化の徹底、チェックリスト整備

- **ローカル環境の障害**
  - 対策：冗長化、クラウドバックアップ（オプション）

### データリスク
- **データ消失リスク**
  - 対策：多重バックアップ、外部ストレージ同期

- **データ不整合リスク**
  - 対策：トランザクション管理、整合性チェック

## 将来拡張要件

### フェーズ2拡張機能
- [ ] 複数会社の管理
- [ ] 請求書テンプレートの複数パターン
- [ ] 支払い状況管理
- [ ] 売上分析・レポート機能

### フェーズ3拡張機能
- [ ] マルチユーザー対応
- [ ] ウェブ経由でのリモートアクセス
- [ ] 会計ソフト連携
- [ ] メール自動送信機能

---

**承認**
- 作成者：AsamiWorks システム開発チーム
- 承認者：プロジェクト責任者
- 作成日：2024年10月28日
- バージョン：1.0