rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for authentication and authorization
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      // Check if user has admin custom claim
      return isAuthenticated() &&
             request.auth.token.admin == true;
    }

    // Alternative admin check using email (fallback)
    function isAdminByEmail() {
      return isAuthenticated() &&
             (request.auth.token.email == 'info@asami-works.com' ||
              request.auth.token.email == 'admin@asami-works.com');
    }

    function isAuthorized() {
      return isAdmin() || isAdminByEmail();
    }

    // Clients collection - Admin full access, clients can read/update their own data
    match /clients/{clientId} {
      // Admin has full access
      allow read, write: if isAuthorized();

      // Authenticated users can read their own client data by email or authUid
      allow read: if isAuthenticated() &&
                     (resource.data.email == request.auth.token.email ||
                      resource.data.authUid == request.auth.uid);

      // Authenticated users can update their own authUid, emailVerified, and hasInitialPassword
      allow update: if isAuthenticated() &&
                       resource.data.email == request.auth.token.email &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['authUid', 'emailVerified', 'hasInitialPassword', 'updatedAt']) &&
                       request.resource.data.authUid == request.auth.uid;
    }

    // Invoices collection - Admin full access, clients can read their own invoices
    match /invoices/{invoiceId} {
      // Admin has full access
      allow read, write: if isAuthorized();

      // Authenticated users can read their own invoices by clientId
      allow read: if isAuthenticated() &&
                     request.auth.token.clientId == resource.data.clientId;
    }

    // Company info (single document) - Admin only access
    match /companyInfo/default {
      allow read, write: if isAuthorized();
    }

    // Invoice counters - Admin only access
    match /invoiceCounters/{counterId} {
      allow read, write: if isAuthorized();
    }

    // Execution logs - Admin only access
    match /executionLogs/{logId} {
      allow read, write: if isAuthorized();
    }

    // Admin management collection (optional)
    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if isAuthorized();
    }

    // ========== Accounting & Financial Management Rules ==========

    // Expenses collection - Admin only access
    match /expenses/{expenseId} {
      allow read, write: if isAuthorized();
    }

    // Business settings - Admin only access
    match /business_settings/{settingId} {
      allow read, write: if isAuthorized();
    }

    // Fixed assets - Admin only access
    match /fixed_assets/{assetId} {
      allow read, write: if isAuthorized();
    }

    // Budgets - Admin only access
    match /budgets/{budgetId} {
      allow read, write: if isAuthorized();
    }

    // Monthly reports - Admin only access
    match /monthly_reports/{reportId} {
      allow read, write: if isAuthorized();
    }

    // Profit and loss statements - Admin only access
    match /profit_and_loss/{plId} {
      allow read, write: if isAuthorized();
    }

    // Balance sheets - Admin only access
    match /balance_sheets/{bsId} {
      allow read, write: if isAuthorized();
    }

    // Cash flow statements - Admin only access
    match /cash_flow_statements/{cfId} {
      allow read, write: if isAuthorized();
    }

    // Withholding tax records - Admin only access
    match /withholding_tax/{taxId} {
      allow read, write: if isAuthorized();
    }

    // Tax return data - Admin only access
    match /tax_returns/{returnId} {
      allow read, write: if isAuthorized();
    }

    // ========== Chat System Rules ==========

    // Users collection - Own user data only
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.email == request.auth.token.email;
      allow update: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.email == resource.data.email;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // Chats collection - Own chats only
    match /chats/{chatId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Inquiries collection - Anyone can create, own inquiries only for read
    match /inquiries/{inquiryId} {
      allow create: if true;
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isAuthorized());
      allow update: if isAuthorized();
      allow delete: if isAuthorized();
    }

    // Deny all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}